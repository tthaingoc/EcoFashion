import "./DesignerLandingPage.css";
import { useEffect, useState } from "react";
import { useParams, useNavigate } from "react-router-dom";
import {
  DesignerService,
  type DesignerPublic,
} from "../../services/api/designerService";
import { toast } from "react-toastify";

// Utility function to check if a string is a valid JSON array
function isValidJsonArray(jsonStr: string | undefined | null): boolean {
  if (typeof jsonStr !== "string" || !jsonStr.trim().startsWith("["))
    return false;
  try {
    const arr = JSON.parse(jsonStr);
    return Array.isArray(arr);
  } catch {
    return false;
  }
}

// Utility function to fallback image URL safely
function safeImageUrl(
  url?: string,
  fallback: string = "/assets/default-image.jpg"
): string {
  return typeof url === "string" && url.trim() ? url : fallback;
}

// Utility function to check valid JSON object
function isValidJsonObject(jsonStr: string | undefined | null): boolean {
  if (typeof jsonStr !== "string" || !jsonStr.trim().startsWith("{"))
    return false;
  try {
    const obj = JSON.parse(jsonStr);
    return typeof obj === "object" && obj !== null && !Array.isArray(obj);
  } catch {
    return false;
  }
}

export default function DesignerLandingPage() {
  const { id } = useParams<{ id: string }>();
  const navigate = useNavigate();
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [designer, setDesigner] = useState<DesignerPublic | null>(null);

  useEffect(() => {
    if (!id) return;
    const fetchDesigner = async () => {
      try {
        setLoading(true);
        const data = await DesignerService.getDesignerPublicProfile(id);
        setDesigner(data);
      } catch (err: any) {
        const msg = err.message || "Kh√¥ng th·ªÉ t·∫£i th√¥ng tin nh√† thi·∫øt k·∫ø.";
        setError(msg);
        toast.error(msg);
      } finally {
        setLoading(false);
      }
    };
    fetchDesigner();
  }, [id]);

  if (loading) return <div className="designer-loading">ƒêang t·∫£i...</div>;
  if (error || !designer)
    return (
      <div className="designer-error">
        <p>{error || "Kh√¥ng t√¨m th·∫•y designer."}</p>
        <button onClick={() => navigate("/explore/designers")}>
          ‚Üê Quay l·∫°i
        </button>
      </div>
    );

  return (
    <div className="designer-page">
      <button
        className="back-btn"
        onClick={() => navigate("/explore/designers")}
      >
        ‚Üê Quay l·∫°i
      </button>

      <div
        className="banner"
        style={{
          backgroundImage: `url(${safeImageUrl(
            designer.bannerUrl,
            "/assets/default-banner.jpg"
          )})`,
        }}
      >
        <div className="overlay" />
        <div className="banner-content">
          <img
            className="avatar"
            src={safeImageUrl(designer.avatarUrl, "/assets/default-avatar.png")}
            alt={designer.designerName || "avatar"}
            onError={(e) => {
              if (
                e.currentTarget.src !==
                window.location.origin + "/assets/default-avatar.png"
              ) {
                e.currentTarget.src = "/assets/default-avatar.png";
              }
            }}
          />
          <div className="info">
            <h2>
              {designer.designerName || designer.userFullName || "Nh√† thi·∫øt k·∫ø"}
            </h2>
            <div className="tags">
              <span className="chip">üé® Nh√† Thi·∫øt K·∫ø</span>
              <span className="chip-outline">
                Th√†nh vi√™n t·ª´ {new Date(designer.createdAt).getFullYear()}
              </span>
              <span className="rating">
                ‚≠ê {designer.rating?.toFixed(1) || "0"} (
                {designer.reviewCount || 0})
              </span>
            </div>
          </div>
        </div>
      </div>

      <div className="content">
        <div className="left">
          <div className="designer-card">
            <h3>üé® Gi·ªõi thi·ªáu</h3>
            <p>
              {designer.bio?.trim() ||
                "ƒêam m√™ th·ªùi trang b·ªÅn v·ªØng v√† th√¢n thi·ªán v·ªõi m√¥i tr∆∞·ªùng."}
            </p>
            <div className="tags">
              <span className="tag">üå± B·ªÅn v·ªØng</span>
              <span className="tag">üé® Hi·ªán ƒë·∫°i</span>
              <span className="tag">‚úîÔ∏è Ch·∫•t l∆∞·ª£ng</span>
            </div>
          </div>

          <div className="designer-card">
            <h3>üåø Chuy√™n m√¥n</h3>
            <a
              className="btn"
              href={designer.specializationUrl?.trim() || "#"}
              target="_blank"
              rel="noopener noreferrer"
            >
              {designer.specializationUrl?.trim()
                ? "Xem chi ti·∫øt"
                : "Ch∆∞a c·∫≠p nh·∫≠t"}
            </a>
          </div>

          <div className="designer-card">
            <h3>üåê Portfolio</h3>
            <a
              className="btn"
              href={designer.portfolioUrl?.trim() || "#"}
              target="_blank"
              rel="noopener noreferrer"
            >
              {designer.portfolioUrl?.trim()
                ? "Xem Portfolio"
                : "Ch∆∞a c·∫≠p nh·∫≠t"}
            </a>
          </div>

          {isValidJsonArray(designer.portfolioFiles) ? (
            (() => {
              const files = JSON.parse(designer.portfolioFiles!);
              return (
                <div className="designer-card">
                  <h3>üñºÔ∏è Portfolio Images</h3>
                  <div className="images">
                    {files.map((url: string, idx: number) => (
                      <img
                        key={idx}
                        src={safeImageUrl(url, "/assets/default-portfolio.jpg")}
                        alt={`portfolio-${idx}`}
                        onError={(e) => {
                          if (
                            e.currentTarget.src !==
                            window.location.origin +
                              "/assets/default-portfolio.jpg"
                          ) {
                            e.currentTarget.src =
                              "/assets/default-portfolio.jpg";
                          }
                        }}
                      />
                    ))}
                  </div>
                </div>
              );
            })()
          ) : (
            <div className="designer-card">
              <h3>üñºÔ∏è Portfolio Images</h3>
              <div className="images">
                <img
                  src="/assets/default-portfolio.jpg"
                  alt="portfolio-default"
                  onError={(e) => {
                    if (
                      e.currentTarget.src !==
                      window.location.origin + "/assets/default-portfolio.jpg"
                    ) {
                      e.currentTarget.src = "/assets/default-portfolio.jpg";
                    }
                  }}
                />
              </div>
            </div>
          )}

          {isValidJsonArray(designer.certificates) ? (
            (() => {
              const certs = JSON.parse(designer.certificates!);
              return (
                <div className="designer-card">
                  <h3>üéñÔ∏è Ch·ª©ng ch·ªâ</h3>
                  <ul>
                    {certs.map((cert: string, idx: number) => (
                      <li key={idx}>{cert}</li>
                    ))}
                  </ul>
                </div>
              );
            })()
          ) : (
            <div className="designer-card">
              <h3>üéñÔ∏è Ch·ª©ng ch·ªâ</h3>
              <div>Ch∆∞a c√≥ ch·ª©ng ch·ªâ</div>
            </div>
          )}

          {isValidJsonObject(designer.socialLinks) &&
            (() => {
              try {
                const links = JSON.parse(designer.socialLinks);
                const hasLinks =
                  links &&
                  (links.instagram?.trim() ||
                    links.behance?.trim() ||
                    links.facebook?.trim() ||
                    links.website?.trim());
                if (hasLinks) {
                  return (
                    <div className="designer-card">
                      <h3>üîó M·∫°ng x√£ h·ªôi</h3>
                      <ul>
                        {links.instagram?.trim() && (
                          <li>
                            <a
                              href={links.instagram}
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Instagram
                            </a>
                          </li>
                        )}
                        {links.behance?.trim() && (
                          <li>
                            <a
                              href={links.behance}
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Behance
                            </a>
                          </li>
                        )}
                        {links.facebook?.trim() && (
                          <li>
                            <a
                              href={links.facebook}
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Facebook
                            </a>
                          </li>
                        )}
                        {links.website?.trim() && (
                          <li>
                            <a
                              href={links.website}
                              target="_blank"
                              rel="noopener noreferrer"
                            >
                              Website
                            </a>
                          </li>
                        )}
                      </ul>
                    </div>
                  );
                }
              } catch {}
              return null;
            })()}
        </div>

        <div className="right">
          <h3>üìû Li√™n h·ªá</h3>
          {designer.email?.trim() && <p>Email: {designer.email}</p>}
          {designer.phoneNumber?.trim() && (
            <p>ƒêi·ªán tho·∫°i: {designer.phoneNumber}</p>
          )}
          {designer.address?.trim() && <p>ƒê·ªãa ch·ªâ: {designer.address}</p>}

          <div className="designer-card">
            <h3>üìä Th·ªëng k√™</h3>
            <p>ƒê√°nh gi√°: {designer.rating?.toFixed(1) || "0"}/5</p>
            <p>L∆∞·ª£t ƒë√°nh gi√°: {designer.reviewCount || 0}</p>
            <p>Th√†nh vi√™n t·ª´: {new Date(designer.createdAt).getFullYear()}</p>
          </div>

          {/* Th√¥ng tin b·ªï sung */}
          {(designer.taxNumber?.trim() ||
            designer.identificationPictureOwner?.trim()) && (
            <div className="designer-card">
              <h3>üìù Th√¥ng tin b·ªï sung</h3>
              {designer.taxNumber?.trim() && (
                <p>
                  <strong>M√£ s·ªë thu·∫ø:</strong> {designer.taxNumber}
                </p>
              )}
              {designer.identificationPictureOwner?.trim() && (
                <p>
                  <strong>Ch·ªß s·ªü h·ªØu ·∫£nh ƒë·ªãnh danh:</strong>{" "}
                  {designer.identificationPictureOwner}
                </p>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
